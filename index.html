<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Multi-Photo Extractor</title>
<script src="https://docs.opencv.org/4.x/opencv.js"></script>
<style>
  body { font-family:sans-serif; padding:1rem; }
  #annotatedCanvas, .crop { max-width:200px; margin:.5rem; border:1px solid #ccc; }
</style>
</head>
<body>
<h3>Select or Capture an Image</h3>
<input type="file" id="fileInput" accept="image/*"><br><br>
<video id="videoInput" width="320" height="240" autoplay></video>
<button id="snap">Capture</button>

<canvas id="canvasInput" style="display:none;"></canvas><br>
<button id="processBtn" disabled>Process</button>

<h4>Annotated:</h4>
<canvas id="annotatedCanvas"></canvas>

<h4>Cropped photos:</h4>
<div id="crops"></div>

<script>
let cvReady = false;
cv['onRuntimeInitialized'] = () => {
  cvReady = true;
  console.log('OpenCV ready');
  enableProcessIfReady();
};

function enableProcessIfReady() {
  const c = document.getElementById('canvasInput');
  if (cvReady && c.width>0 && c.height>0) {
    document.getElementById('processBtn').disabled = false;
  }
}

// camera preview
navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
  document.getElementById('videoInput').srcObject=stream;
});

document.getElementById('snap').onclick=()=>{
  const video=document.getElementById('videoInput');
  const c=document.getElementById('canvasInput');
  c.width=video.videoWidth;
  c.height=video.videoHeight;
  c.getContext('2d').drawImage(video,0,0);
  enableProcessIfReady();
};

// upload file
document.getElementById('fileInput').onchange=e=>{
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.getElementById('canvasInput');
      c.width=img.width;
      c.height=img.height;
      c.getContext('2d').drawImage(img,0,0);
      enableProcessIfReady();
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
};

document.getElementById('processBtn').onclick=()=>{
  if(!cvReady){alert('OpenCV not loaded yet');return;}
  const c=document.getElementById('canvasInput');
  if(c.width===0){alert('No image loaded');return;}

  const src=cv.imread(c);
  const gray=new cv.Mat();
  cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY,0);
  const blurred=new cv.Mat();
  cv.GaussianBlur(gray,blurred,new cv.Size(5,5),0,0,cv.BORDER_DEFAULT);
  const edges=new cv.Mat();
  cv.Canny(blurred,edges,50,150);

  const contours=new cv.MatVector();
  const hierarchy=new cv.Mat();
  cv.findContours(edges,contours,hierarchy,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

  const cropsDiv=document.getElementById('crops');
  cropsDiv.innerHTML='';
  const annotated=src.clone();

  for(let i=0;i<contours.size();i++){
    const cnt=contours.get(i);
    const peri=cv.arcLength(cnt,true);
    const approx=new cv.Mat();
    cv.approxPolyDP(cnt,approx,0.02*peri,true);

    if(approx.rows===4){
      const area=cv.contourArea(approx);
      if(area>3000){
        // order corners
        let pts=[];
        for(let j=0;j<4;j++){pts.push({x:approx.intAt(j,0),y:approx.intAt(j,1)});}
        pts.sort((a,b)=>a.y-b.y);
        let top=pts.slice(0,2).sort((a,b)=>a.x-b.x);
        let bot=pts.slice(2).sort((a,b)=>a.x-b.x);
        let ordered=[top[0],top[1],bot[1],bot[0]];
        let w=Math.max(
          Math.hypot(ordered[0].x-ordered[1].x,ordered[0].y-ordered[1].y),
          Math.hypot(ordered[2].x-ordered[3].x,ordered[2].y-ordered[3].y));
        let h=Math.max(
          Math.hypot(ordered[0].x-ordered[3].x,ordered[0].y-ordered[3].y),
          Math.hypot(ordered[1].x-ordered[2].x,ordered[1].y-ordered[2].y));
        let srcTri=cv.matFromArray(4,1,cv.CV_32FC2,
          [ordered[0].x,ordered[0].y,
           ordered[1].x,ordered[1].y,
           ordered[2].x,ordered[2].y,
           ordered[3].x,ordered[3].y]);
        let dstTri=cv.matFromArray(4,1,cv.CV_32FC2,[0,0,w,0,w,h,0,h]);
        let M=cv.getPerspectiveTransform(srcTri,dstTri);
        let dst=new cv.Mat();
        cv.warpPerspective(src,dst,M,new cv.Size(w,h),cv.INTER_LINEAR,cv.BORDER_REPLICATE);

        // draw rectangle on annotated
        cv.polylines(annotated,approx,true,new cv.Scalar(255,0,0,255),3);

        // show crop
        let cropCanvas=document.createElement('canvas');
        cv.imshow(cropCanvas,dst);
        cropCanvas.className='crop';
        cropsDiv.appendChild(cropCanvas);

        dst.delete();M.delete();srcTri.delete();dstTri.delete();
      }
    }
    cnt.delete();approx.delete();
  }

  // show annotated
  const annotatedCanvas=document.getElementById('annotatedCanvas');
  cv.imshow(annotatedCanvas,annotated);

  // clean up
  src.delete();gray.delete();blurred.delete();edges.delete();contours.delete();hierarchy.delete();annotated.delete();
};
</script>
</body>
</html>
